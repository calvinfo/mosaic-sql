var E=class{table;column;label;constructor(t,e){t&&(this.table=String(t)),e&&(this.column=e)}get columns(){return this.column?[this.column]:[]}toString(){let{table:t,column:e}=this;if(e){let n=e.startsWith("*")?e:`"${e}"`;return`${t?`${W(t)}.`:""}${n}`}else return t?W(t):"NULL"}};function W(r){return r.split(".").map(e=>`"${e}"`).join(".")}function Y(r,t){return r instanceof E&&r.column===t}function l(r){return typeof r=="string"?V(r):r}function O(r){return typeof r=="string"?B(r):r}function B(r){return new E(r)}function V(r,t){return typeof t=="string"?new E(r,t):new E(void 0,r)}function nt(r){return new E(r,"*")}function st(r){return typeof r=="string"?`"${r}"`:R(r)}function R(r){switch(typeof r){case"boolean":return r?"TRUE":"FALSE";case"string":return`'${r}'`;case"number":return Number.isFinite(r)?String(r):"NULL";default:if(r==null)return"NULL";if(r instanceof Date){let t=+r;if(Number.isNaN(t))return"NULL";let e=r.getUTCFullYear(),n=r.getUTCMonth(),s=r.getUTCDate();return t===Date.UTC(e,n,s)?`MAKE_DATE(${e}, ${n+1}, ${s})`:`EPOCH_MS(${t})`}else return r instanceof RegExp?`'${r.source}'`:String(r)}}var L=r=>typeof r?.addEventListener=="function";function _(r){return r instanceof w}var w=class{_expr;_deps;_params;_map;aggregate;label;addEventListener;constructor(t,e,n){this._expr=Array.isArray(t)?t:[t],this._deps=e||[],this.annotate(n);let s=this._expr.filter(o=>L(o));s.length>0?(this._params=Array.from(new Set(s)),this._params.forEach(o=>{o.addEventListener("value",()=>ot(this,this._map?.get("value")))}),this.addEventListener=(o,i)=>{let a=this._map||(this._map=new Map);(a.get(o)||(a.set(o,new Set),a.get(o))).add(i)}):this.addEventListener=void 0}get value(){return this}get columns(){let{_params:t,_deps:e}=this;if(t){let n=new Set(t.flatMap(s=>{let o=s.value?.columns;return Array.isArray(o)?o:[]}));if(n.size){let s=new Set(e);return n.forEach(o=>s.add(o)),Array.from(s)}}return e}get column(){return this._deps.length?this._deps[0]:this.columns[0]}annotate(...t){return Object.assign(this,...t)}toString(){return this._expr.map(t=>L(t)&&!_(t)?R(t.value):t).join("")}};function ot(r,t){if(t?.size)return Promise.allSettled(Array.from(t,e=>e(r)))}function U(r,t){let e=[r[0]],n=new Set,s=t.length;for(let o=0,i=0;o<s;){let a=t[o];L(a)?e[++i]=a:(Array.isArray(a?.columns)&&a.columns.forEach(y=>n.add(y)),e[i]+=typeof a=="string"?a:R(a));let p=r[++o];L(e[i])?e[++i]=p:e[i]+=p}return{spans:e,cols:Array.from(n)}}function c(r,...t){let{spans:e,cols:n}=U(r,t);return new w(e,n)}function it(r){let t=l(r);return c`${t} DESC NULLS LAST`.annotate({label:t?.label,desc:!0})}var at=r=>({value:r,toString:()=>R(r)});function I(r){r(this.op,this),this.children?.forEach(t=>t.visit(r))}function X(r,t){let e=t.filter(s=>s!=null).map(l),n=e.map((s,o)=>o?` ${r} `:"");return e.length===1?n.push(""):e.length>1&&(n[0]="(",n.push(")")),c(n,...e).annotate({op:r,children:e,visit:I})}var ut=(...r)=>X("AND",r.flat()),ct=(...r)=>X("OR",r.flat()),lt=r=>t=>c`(${r} ${l(t)})`.annotate({op:r,a:t,visit:I}),pt=lt("NOT"),H=r=>t=>c`(${l(t)} ${r})`.annotate({op:r,a:t,visit:I}),ft=H("IS NULL"),gt=H("IS NOT NULL"),$=r=>(t,e)=>c`(${l(t)} ${r} ${l(e)})`.annotate({op:r,a:t,b:e,visit:I}),mt=$("="),yt=$("<>"),ht=$("<"),dt=$(">"),xt=$("<="),Et=$(">="),Rt=$("IS DISTINCT FROM"),St=$("IS NOT DISTINCT FROM");function K(r,t,e,n){t=l(t);let s=r.startsWith("NOT ")?"NOT ":"";return(e?n?c`${s}(${e[0]} <= ${t} AND ${t} < ${e[1]})`:c`(${t} ${r} ${e[0]} AND ${e[1]})`:c``).annotate({op:r,visit:I,field:t,range:e})}var bt=(r,t,e)=>K("BETWEEN",r,t,e),wt=(r,t,e)=>K("NOT BETWEEN",r,t,e);function N(r,t){return Array.from({length:r},()=>t)}function d(r,t){return(...e)=>{let n=e.map(l),s=t?`::${t}`:"";return(n.length?c([`${r}(`,...N(n.length-1,", "),`)${s}`],...n):c`${r}()${s}`).annotate({func:r,args:n})}}var $t=d("REGEXP_MATCHES"),Lt=d("CONTAINS"),Nt=d("PREFIX"),At=d("SUFFIX"),Tt=d("LOWER"),qt=d("UPPER"),Qt=d("LENGTH"),Ot=d("ISNAN"),It=d("ISFINITE"),Dt=d("ISINF");var D=class r extends w{func;type;name;group;order;frame;window;constructor(t,e,n=null,s,o="",i="",a=""){let p;if(s&&!(o||i||a))p=s?c`${e} OVER "${s}"`:c`${e} OVER ()`;else{let T=o&&i?" ":"",q=(o||i)&&a?" ":"";p=c`${e} OVER (${s?`"${s}" `:""}${o}${T}${i}${q}${a})`}n&&(p=c`(${p})::${n}`);let{_expr:h,_deps:b}=p;super(h,b),this.window=t,this.func=e,this.type=n,this.name=s,this.group=o,this.order=i,this.frame=a,this.label=e.label??e.toString()}get basis(){return this.column}over(t){let{window:e,func:n,type:s,group:o,order:i,frame:a}=this;return new r(e,n,s,t,o,i,a)}partitionby(...t){let e=t.flat().filter(h=>h).map(l),n=c(["PARTITION BY ",...N(e.length-1,", "),""],...e),{window:s,func:o,type:i,name:a,order:p,frame:y}=this;return new r(s,o,i,a,n,p,y)}orderby(...t){let e=t.flat().filter(h=>h).map(l),n=c(["ORDER BY ",...N(e.length-1,", "),""],...e),{window:s,func:o,type:i,name:a,group:p,frame:y}=this;return new r(s,o,i,a,p,n,y)}rows(t){let e=z("ROWS",t),{window:n,func:s,type:o,name:i,group:a,order:p}=this;return new r(n,s,o,i,a,p,e)}range(t){let e=z("RANGE",t),{window:n,func:s,type:o,name:i,group:a,order:p}=this;return new r(n,s,o,i,a,p,e)}};function z(r,t){if(L(t)){let e=c`${t}`;return e.toString=()=>`${r} ${J(t.value)}`,e}return`${r} ${J(t)}`}function J(r){let[t,e]=r,n=t===0?"CURRENT ROW":Number.isFinite(t)?`${Math.abs(t)} PRECEDING`:"UNBOUNDED PRECEDING",s=e===0?"CURRENT ROW":Number.isFinite(e)?`${Math.abs(e)} FOLLOWING`:"UNBOUNDED FOLLOWING";return`BETWEEN ${n} AND ${s}`}function S(r,t){return(...e)=>{let n=d(r)(...e);return new D(r,n,t)}}var _t=S("ROW_NUMBER","INTEGER"),Ct=S("RANK","INTEGER"),Ft=S("DENSE_RANK","INTEGER"),Pt=S("PERCENT_RANK"),kt=S("CUME_DIST"),Ut=S("NTILE"),Mt=S("LAG"),jt=S("LEAD"),Gt=S("FIRST_VALUE"),vt=S("LAST_VALUE"),Wt=S("NTH_VALUE");function Yt(r,...t){return c(r,...t).annotate({aggregate:!0})}var M=class r extends w{isDistinct;filter;type;aggregate;args;constructor(t,e,n=null,s,o){e=(e||[]).map(l);let{strings:i,exprs:a}=Bt(t,e,n,s,o),{spans:p,cols:y}=U(i,a);super(p,y),this.aggregate=t,this.args=e,this.type=n,this.isDistinct=s||!1,this.filter=o||null;let h=this.isDistinct?"DISTINCT ":"",b=this.args.length?`(${h}${this.args.map(Vt).join(", ")})`:"";this.label=`${t.toLowerCase()}${b}`}get basis(){return this.column}distinct(){let{aggregate:t,args:e,type:n,filter:s}=this;return new r(t,e,n,!0,s)}where(t){let{aggregate:e,args:n,type:s,isDistinct:o}=this;return new r(e,n,s,o,t)}window(){let{aggregate:t,args:e,type:n,isDistinct:s}=this,o=new r(t,e,null,s);return new D(t,o,n)}partitionby(...t){return this.window().partitionby(...t)}orderby(...t){return this.window().orderby(...t)}rows([t,e]){return this.window().rows([t,e])}range([t,e]){return this.window().range([t,e])}};function Bt(r,t,e=null,n,s){let o=`)${e?`::${e}`:""}`,i=[`${r}(${n?"DISTINCT ":""}`],a=[];return t.length?(i=i.concat([...N(t.length-1,", "),`${o}${s?" FILTER (WHERE ":""}`,...s?[")"]:[]]),a=[...t,...s?[s]:[]]):i[0]+="*"+o,{exprs:a,strings:i}}function Vt(r){let t=R(r);return t&&t.startsWith('"')&&t.endsWith('"')?t.slice(1,-1):t}function u(r,t){return(...e)=>new M(r,e,t)}var Xt=u("COUNT","INTEGER"),Ht=u("AVG"),Kt=u("AVG"),zt=u("MAD"),Jt=u("MAX"),Zt=u("MIN"),te=u("SUM","DOUBLE"),ee=u("PRODUCT"),re=u("MEDIAN"),ne=u("QUANTILE"),se=u("MODE"),oe=u("VARIANCE"),ie=u("STDDEV"),ae=u("SKEWNESS"),ue=u("KURTOSIS"),ce=u("ENTROPY"),le=u("VAR_POP"),pe=u("STDDEV_POP"),fe=u("CORR"),ge=u("COVAR_POP"),me=u("REGR_INTERCEPT"),ye=u("REGR_SLOPE"),he=u("REGR_COUNT"),de=u("REGR_R2"),xe=u("REGR_SYY"),Ee=u("REGR_SXX"),Re=u("REGR_SXY"),Se=u("REGR_AVGX"),be=u("REGR_AVGY"),we=u("FIRST"),$e=u("LAST"),Le=u("ARG_MIN"),Ne=u("ARG_MAX"),Ae=u("STRING_AGG"),Te=u("ARRAY_AGG");function j(r,t){let e=l(r),n=c`CAST(${e} AS ${t})`;return Object.defineProperty(n,"label",{enumerable:!0,get(){return r.label}}),Object.defineProperty(n,"aggregate",{enumerable:!0,get(){return r.aggregate||!1}}),n}var qe=r=>j(r,"DOUBLE"),Qe=r=>j(r,"INTEGER");var Oe=r=>{let t=l(r);return c`(1000 * (epoch(${t}) - second(${t})) + millisecond(${t}))::DOUBLE`},Ie=r=>{let t=l(r);return c`MAKE_DATE(2012, MONTH(${t}), 1)`.annotate({label:"month"})},De=r=>{let t=l(r);return c`MAKE_DATE(2012, MONTH(${t}), DAY(${t}))`.annotate({label:"date"})},_e=r=>{let t=l(r);return c`MAKE_DATE(2012, 1, DAY(${t}))`.annotate({label:"date"})};var P=class r{cteFor;query;static select(...t){return new r().select(...t)}static from(...t){return new r().from(...t)}static with(...t){return new r().with(...t)}static union(...t){return new A("UNION",t.flat())}static unionAll(...t){return new A("UNION ALL",t.flat())}static intersect(...t){return new A("INTERSECT",t.flat())}static except(...t){return new A("EXCEPT",t.flat())}constructor(){this.query={with:[],select:[],from:[],where:[],groupby:[],having:[],window:[],qualify:[],orderby:[]}}clone(){let t=new r;return t.query={...this.query},t}with(...t){let{query:e}=this;if(t.length===0)return e.with;{let n=[],s=(o,i)=>{let a=i.clone();a.cteFor=this,n.push({as:o,query:a})};return t.flat().forEach(o=>{if(o!=null)if(o.as&&o.query&&typeof o.as=="string")s(o.as,o.query);else for(let i in o)s(i,o[i])}),e.with=e.with.concat(n),this}}select(...t){let{query:e}=this;if(t.length===0)return e.select;{let n=[];for(let s of t.flat())if(s!=null)if(typeof s=="string")n.push({as:s,expr:l(s)});else if(s instanceof E)n.push({as:s.column,expr:s});else if(Array.isArray(s))n.push({as:s[0],expr:s[1]});else for(let o in s)n.push({as:C(o),expr:l(s[o])});return e.select=e.select.concat(n),this}}$select(...t){return this.query.select=[],this.select(...t)}distinct(t=!0){return this.query.distinct=!!t,this}from(...t){let{query:e}=this;if(t.length===0)return e.from;{let n=[];return t.flat().forEach(s=>{if(s!=null)if(typeof s=="string")n.push({as:s,from:O(s)});else if(s instanceof E)n.push({as:s.table,from:s});else if(F(s)||_(s))n.push({from:s});else if(Array.isArray(s))n.push({as:C(s[0]),from:O(s[1])});else{let o=s;for(let i in o)n.push({as:C(i),from:O(o[i])})}}),e.from=e.from.concat(n),this}}$from(...t){return this.query.from=[],this.from(...t)}sample(t,e){let{query:n}=this;if(arguments.length===0)return n.sample;{let s=t;return typeof t=="number"&&(s=t>0&&t<1?{perc:100*t,method:e}:{rows:Math.round(t),method:e}),n.sample=s,this}}where(...t){let{query:e}=this;return t.length===0?e.where:(e.where=e.where.concat(t.flat().filter(n=>n)),this)}$where(...t){return this.query.where=[],this.where(...t)}groupby(...t){let{query:e}=this;return t.length===0?e.groupby:(e.groupby=e.groupby.concat(t.flat().filter(n=>n).map(l)),this)}$groupby(...t){return this.query.groupby=[],this.groupby(...t)}having(...t){let{query:e}=this;return t.length===0?e.having:(e.having=e.having.concat(t.flat().filter(n=>n)),this)}window(...t){let{query:e}=this;if(t.length===0)return e.window;{let n=[];return t.flat().forEach(s=>{if(s!=null)for(let o in s)n.push({as:C(o),expr:s[o]})}),e.window=e.window.concat(n),this}}qualify(...t){let{query:e}=this;return t.length===0?e.qualify:(e.qualify=e.qualify.concat(t.flat().filter(n=>n)),this)}orderby(...t){let{query:e}=this;return t.length===0?e.orderby:(e.orderby=e.orderby.concat(t.flat().filter(n=>n).map(l)),this)}limit(t){let{query:e}=this;return arguments.length===0?e.limit:(e.limit=Number.isFinite(t)?t:void 0,this)}offset(t){let{query:e}=this;return arguments.length===0?e.offset:(e.offset=Number.isFinite(t)?t:void 0,this)}get subqueries(){let{query:t,cteFor:e}=this,s=(e?.query||t).with?.reduce((i,a)=>(i[a.as]=a.query,i),{}),o=[];return t.from.forEach(({from:i})=>{if(F(i))o.push(i);else if(s[i.table]){let a=s[i.table];o.push(a)}}),o}toString(){let{select:t,distinct:e,from:n,sample:s,where:o,groupby:i,having:a,window:p,qualify:y,orderby:h,limit:b,offset:T,with:q}=this.query,m=[];if(q.length){let f=q.map(({as:g,query:x})=>`"${g}" AS (${x})`);m.push(`WITH ${f.join(", ")}`)}let tt=t.map(({as:f,expr:g})=>Y(g,f)&&!g.table?`${g}`:`${g} AS "${f}"`);if(m.push(`SELECT${e?" DISTINCT":""} ${tt.join(", ")}`),n.length){let f=n.map(({as:g,from:x})=>{let Q=F(x)?`(${x})`:`${x}`;return!g||g===x.table?Q:`${Q} AS "${g}"`});m.push(`FROM ${f.join(", ")}`)}if(o.length){let f=o.map(String).filter(g=>g).join(" AND ");f&&m.push(`WHERE ${f}`)}if(s){let{rows:f,perc:g,method:x,seed:Q}=s,et=f?`${f} ROWS`:`${g} PERCENT`,rt=x?` (${x}${Q!=null?`, ${Q}`:""})`:"";m.push(`USING SAMPLE ${et}${rt}`)}if(i.length&&m.push(`GROUP BY ${i.join(", ")}`),a.length){let f=a.map(String).filter(g=>g).join(" AND ");f&&m.push(`HAVING ${f}`)}if(p.length){let f=p.map(({as:g,expr:x})=>`"${g}" AS (${x})`);m.push(`WINDOW ${f.join(", ")}`)}if(y.length){let f=y.map(String).filter(g=>g).join(" AND ");f&&m.push(`QUALIFY ${f}`)}return h.length&&m.push(`ORDER BY ${h.join(", ")}`),Number.isFinite(b)&&m.push(`LIMIT ${b}`),Number.isFinite(T)&&m.push(`OFFSET ${T}`),m.join(" ")}},A=class r{op;queries;cteFor;query;constructor(t,e){this.op=t,this.queries=e.map(n=>n.clone()),this.query={orderby:[]}}clone(){let t=new r(this.op,this.queries);return t.query={...this.query},t}orderby(...t){let{query:e}=this;return t.length===0?e.orderby:(e.orderby=e.orderby.concat(t.flat().filter(n=>n).map(l)),this)}limit(t){let{query:e}=this;return arguments.length===0?e.limit:(e.limit=Number.isFinite(t)?t:void 0,this)}offset(t){let{query:e}=this;return arguments.length===0?e.offset:(e.offset=Number.isFinite(t)?t:void 0,this)}get subqueries(){let{queries:t,cteFor:e}=this;return e&&t.forEach(n=>n.cteFor=e),t}toString(){let{op:t,queries:e,query:{orderby:n,limit:s,offset:o}}=this,i=[e.join(` ${t} `)];return n.length&&i.push(`ORDER BY ${n.join(", ")}`),Number.isFinite(s)&&i.push(`LIMIT ${s}`),Number.isFinite(o)&&i.push(`OFFSET ${o}`),i.join(" ")}};function F(r){return r instanceof P||r instanceof A}function C(r){return Ce(r)?r.slice(1,-1):r}function Ce(r){return r[0]==='"'&&r[r.length-1]==='"'}function k(r,t,{replace:e=!1,temp:n=!0,view:s=!1}){return"CREATE"+(e?" OR REPLACE ":" ")+(n?"TEMP ":"")+(s?"VIEW":"TABLE")+(e?" ":" IF NOT EXISTS ")+r+" AS "+t}function Z(r,{columns:t}={}){t||(t=Object.keys(r[0]));let e=[];if(Array.isArray(t)?(e=t,t=e.reduce((o,i)=>(o[i]=i,o),{})):t&&(e=Object.keys(t)),!e.length)throw new Error("Can not create table from empty column set.");let n=[],s=t;for(let o of r){let i=e.map(a=>`${R(o[a])} AS "${s[a]}"`);n.push(`(SELECT ${i.join(", ")})`)}return n.join(" UNION ALL ")}function v(r,t,e,n={},s={}){let{select:o=["*"],where:i,view:a,temp:p,replace:y,...h}=n,b=Me({...s,...h}),T=`${r}('${e}'${b?", "+b:""})`,q=i?` WHERE ${i}`:"",m=`SELECT ${o.join(", ")} FROM ${T}${q}`;return k(t,m,{view:a,temp:p,replace:y})}function Fe(r,t,e){return v("read_csv",r,t,e,{auto_detect:!0,sample_size:-1})}function Pe(r,t,e){return v("read_json",r,t,e,{auto_detect:!0,json_format:"auto"})}function ke(r,t,e){return v("read_parquet",r,t,e)}function Ue(r,t,e={}){let{select:n=["*"],...s}=e,o=Z(t),i=n.length===1&&n[0]==="*"?o:`SELECT ${n} FROM ${o}`;return k(r,i,s)}function Me(r){return Object.entries(r).map(([t,e])=>`${t}=${G(e)}`).join(", ")}function G(r){switch(typeof r){case"boolean":return String(r);case"string":return`'${r}'`;case"undefined":case"object":return r==null?"NULL":Array.isArray(r)?"["+r.map(t=>G(t)).join(", ")+"]":"{"+Object.entries(r).map(([t,e])=>`'${t}': ${G(e)}`).join(", ")+"}";default:return r}}export{P as Query,E as Ref,Yt as agg,nt as all,ut as and,Ne as argmax,Le as argmin,Te as arrayAgg,l as asColumn,O as asRelation,Ht as avg,j as cast,qe as castDouble,Qe as castInteger,V as column,Lt as contains,fe as corr,Xt as count,ge as covarPop,k as create,kt as cume_dist,_e as dateDay,Ie as dateMonth,De as dateMonthDay,Ft as dense_rank,it as desc,ce as entropy,Oe as epoch_ms,mt as eq,we as first,Gt as first_value,dt as gt,Et as gte,bt as isBetween,Rt as isDistinct,It as isFinite,Dt as isInfinite,Ot as isNaN,wt as isNotBetween,St as isNotDistinct,gt as isNotNull,ft as isNull,L as isParamLike,F as isQuery,_ as isSQLExpression,ue as kurtosis,Mt as lag,$e as last,vt as last_value,jt as lead,Qt as length,at as literal,R as literalToSQL,Fe as loadCSV,Pe as loadJSON,Ue as loadObjects,ke as loadParquet,Tt as lower,ht as lt,xt as lte,zt as mad,Jt as max,Kt as mean,re as median,Zt as min,se as mode,yt as neq,pt as not,Wt as nth_value,Ut as ntile,ct as or,Pt as percent_rank,Nt as prefix,ee as product,ne as quantile,Ct as rank,$t as regexp_matches,Se as regrAvgX,be as regrAvgY,he as regrCount,me as regrIntercept,de as regrR2,Ee as regrSXX,Re as regrSXY,xe as regrSYY,ye as regrSlope,B as relation,_t as row_number,ae as skewness,c as sql,ie as stddev,pe as stddevPop,Ae as stringAgg,At as suffix,te as sum,st as toSQL,qt as upper,le as varPop,oe as variance};
